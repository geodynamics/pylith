<?xml version="1.0"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
  "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">
<chapter id="chapter_runpylith">
  <title>Running PyLith</title>

  <!-- SECTION +++++++++++++++++++++++++++++++++++++++++++++++++++ -->
  <section>
    <title>Supported Finite Elements</title>
    <para>
      PyLith currently only supports the 4-node linear tetrahedral
      element. The node ordering must follow the convention shown in
      <xref linkend="fig_tet4" />. Support for the 8-node linear
      hexahedral element will be included in PyLith version 0.8.1,
      expected to be released in July 2006.
    </para>

    <figure id="fig_tet4">
      <title>Linear tetrahedral finite element.</title>
      <mediaobject>
	<imageobject role="fo">
	  <imagedata fileref="figs/tet4.eps" format="EPS" />
	</imageobject>
	<imageobject role="xhtml,html">
	  <imagedata fileref="figs/tet4.png" format="PNG" />
	</imageobject>
      </mediaobject>
    </figure>
  </section>

  <!-- SECTION +++++++++++++++++++++++++++++++++++++++++++++++++++ -->
  <section>
    <title>Input Files</title>
    <para>
      PyLith gets its input from a variety of files. Most of these are
      associated with different kinds of boundary conditions. As a
      result only six are required. The remaining files are only used
      when the associated boundary condition is used. See <xref
      linkend="appendix_fileformats" /> for a detailed discussion of
      the file formats.
    </para>
    <para>
      The first step in the simulation process involves partitioning
      the mesh among the processors. In this phase, PyLith reads in
      the entire mesh and then writes out processor specific pieces
      with one file for each processor. The filenames for these
      processors follow the convention
      <filename>xx.PROC.ext</filename> where <filename>PROC</filename>
      refers to the processor number and the original filename was
      <filename>xx.ext</filename>. This procedure is applied to files
      with the following extensions: <filename>coord</filename>,
      <filename>connect</filename>, <filename>split</filename>,
      <filename>bc</filename>. The other files provide information
      common to all processors. As a result, the user must create
      copies of each one for each of the processors with filenames
      following the same form <filename>xx.PROC.ext</filename>. This
      is most easily done using a shell script that starts a
      simulation. See <filename>runbm5.sh</filename> in <xref
      linkend="tutorial_scecbm5" /> for an illustration of how to do
      this.
    </para>

    <!-- SECTION +++++++++++++++++++++++++++++++++++++++++++++++++ -->
    <section>
      <title>Required Input Files</title>
      <para>
        The required input files define the finite-element mesh,
        boundary conditions, time step information, output, and
        material properties.
      </para>
      <variablelist>
	<varlistentry>
	  <term><filename>xx.coord</filename></term>
	  <listitem>
	    <para>
              Coordinates of finite-element vertices.
            </para>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><filename>xx.connect</filename></term>
	  <listitem>
	    <para>
              Topology of finite-element mesh.
            </para>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><filename>xx.bc</filename></term>
	  <listitem>
	    <para>
              Boundary conditions at nodes on external boundaries.
            </para>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><filename>xx.time</filename></term>
	  <listitem>
	    <para>
              Time stepping information.
            </para>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><filename>xx.statevar</filename></term>
	  <listitem>
	    <para>
              State variables to be output for the elastic and
              (time-dependent) viscoelastic solution.
            </para>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><filename>xx.prop</filename></term>
	  <listitem>
	    <para>
              Properties for each material.
            </para>
	  </listitem>
	</varlistentry>
      </variablelist>
    </section>

    <!-- SECTION +++++++++++++++++++++++++++++++++++++++++++++++++ -->
    <section>
      <title>Optional Input Files</title>
      <para>
        The optional input files are only included when the associated
        boundary conditions are specified in the boundary condition
        file, <filename>xx.bc</filename>.
      </para>
      <variablelist>
	<varlistentry>
	  <term><filename>xx.fuldat</filename></term>
	  <listitem>
	    <para>
              Time steps for which full output is requested.
            </para>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><filename>xx.split</filename></term>
	  <listitem>
	    <para>
              Dislocation boundary condition information (implemented
              using split nodes).
            </para>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><filename>xx.skew</filename></term>
	  <listitem>
	    <para>
              Local coordinate rotation information for boundary
              conditions.
            </para>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><filename>xx.keyval</filename></term>
	  <listitem>
	    <para>
              Simple parameter settings for various boundary
              conditions.
            </para>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><filename>xx.wink</filename></term>
	  <listitem>
	    <para>
              Winkler sprint element boundary condition
              information. Not yet tested.
            </para>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><filename>xx.hist</filename></term>
	  <listitem>
	    <para>
              Time history boundary conditions. Not yet tested?? 
              CHARLES - IS THIS FOR DISLOCATION BOUNDARY CONDITIONS OR
              EXTERNAL BOUNDARY CONDITIONS??
            </para>
	  </listitem>
	</varlistentry>
      </variablelist>
    </section>

  </section>

  <!-- SECTION +++++++++++++++++++++++++++++++++++++++++++++++++++ -->
  <section>
    <title>Command-line Arguments</title>
    <para>
      Command-line arguments associated with running PyLith fall into
      three categories: MPI settings, Pyre properties and facilities,
      and PETSc settings.
    </para>

    <!-- SECTION +++++++++++++++++++++++++++++++++++++++++++++++++++ -->
    <section>
      <title>MPI Settings</title>

      <warning>
	<para>
          This section applies only to PyLith compiled using the MPICH
          implementation of the Message Passing Interface (MPI).
        </para>
      </warning>

      <para>
        The MPI settings define how many processors are used and other
        parallel processing parameters. The number of processors is
        specified using <option>-np NPROCS</option>, where
        <literal>NPROCS</literal> corresponds to the number of
        processors.
      </para>


    </section>

    <!-- SECTION +++++++++++++++++++++++++++++++++++++++++++++++++++ -->
    <section>
      <title>Properties and Facilities</title>
      <para>
        PyLith gathers many simulation parameters and settings using
        Pyre properties and facilities. Properties correspond to
        simple settings in the form of strings, integers, and real
        numbers. Facilities corresponds to software modules. Both
        facilities and properties have default values provided, so you
        only need to set values when you want to deviate from the
        default behavior. Unless you write a module that extends
        PyLith's functionality, you will never need to change any of
        the facilities from the defaults.
      </para>
      <para>
        In the current version of PyLith, all of the properties are
        associated with the "scanner" component. You can get a list of
        all of these properties along with a description of what they
        do by running PyLith with the
        <option>--scanner.help-properties</option> command-line
        argument.
      </para>

      <example id="example_pylith_properties">
	<title>Setting scanner properties from the command line.</title>
	<screen>
          <cmdsynopsis>
	    <command>mpirun</command>
	    <arg choice="plain">-np <replaceable>1</replaceable></arg> 
	    <arg choice="plain">pylith3dapp.py</arg>
	    <arg>--scanner.help-properties</arg><sbr/>
	    <arg>--scanner.asciiOutput=<replaceable>none</replaceable></arg>
	    <arg>--scanner.title=<replaceable>"My simulation"</replaceable></arg>
	  </cmdsynopsis>
        </screen>
      </example>
       
    </section>

    <!-- SECTION +++++++++++++++++++++++++++++++++++++++++++++++++++ -->
    <section>
      <title>PETSc Settings</title>
      <para>
        PyLith relies on PETSc for the linear algebra
        computations. Many of PETSc options can be set using
        command-line arguments. The ones of primary interest in the
        case of PyLith are shown in <xref
	  linkend="table_petsc_options" />.
      </para>
      
      <table id="table_petsc_options">
	<title>Useful command-line arguments for setting PETSc options.</title>

	<tgroup cols="2" align="left">
	  <thead>
	    <row>
	      <entry>Argument</entry>
	      <entry>Description</entry>
	    </row>
	  </thead>
	  <tbody>
	    <row>
	      <entry><cmdsynopsis>
		  <arg choice="plain">-log_summary</arg>
		</cmdsynopsis></entry>
	      <entry>Print logging objects and events.</entry>
	    </row>
	    <row>
	      <entry><cmdsynopsis>
		  <arg choice="plain">-sub_pc_type
                  <replaceable>ilu</replaceable></arg>
		</cmdsynopsis></entry>
	      <entry>Set preconditioner to incomplete factorization. See
                PETSc documentation for a list of all preconditioners.</entry>
	    </row>
	    <row>
	      <entry><cmdsynopsis>
		  <arg choice="plain">-ksp_monitor</arg>
		</cmdsynopsis></entry>
	      <entry>Dump preconditioned residual norm to stdout.</entry>
	    </row>
	    <row>
	      <entry><cmdsynopsis>
		  <arg choice="plain">-ksp_view</arg>
		</cmdsynopsis></entry>
	      <entry>Print linear solver parameters.</entry>
	    </row>
	    <row>
	      <entry><cmdsynopsis>
		  <arg choice="plain">-ksp_rtol
		  <replaceable>1.0e-09</replaceable></arg>
		</cmdsynopsis></entry>
	      <entry>Relative decrease in residual norm</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

    </section>

  </section>

  <!-- SECTION +++++++++++++++++++++++++++++++++++++++++++++++++++ -->
  <section>
    <title>Setting Pyre properties using pml files</title>
    <para>
      PyLith's Pyre properties can also be set using
      <filename>pml</filename> files. These are <acronym>XML</acronym>
      files that follow a special Pyre XML schema.
    </para>
    <para>
      ADD STUFF HERE
    </para>

  </section>

</chapter>
