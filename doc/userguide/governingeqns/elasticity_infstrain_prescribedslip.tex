% ----------------------------------------------------------------------
\section{Elasticity with Infinitesimal Strain and Prescribed Slip on Faults}

We begin with the elasticity equation including the inertial term,
\begin{gather}
  \label{eqn:elasticity:strong:form}
  \rho \frac{\partial^2\vec{u}}{\partial t^2} - \vec{f}(\vec{x},t) - \tensor{\nabla} \cdot 
\tensor{\sigma}
(\vec{u}) = \vec{0} \text{ in }\Omega, \\
%
  \label{eqn:bc:Neumann}
  \tensor{\sigma} \cdot \vec{n} = \vec{\tau}(\vec{x},t) \text{ on }\Gamma_\tau, \\
%
  \label{eqn:bc:Dirichlet}
  \vec{u} = \vec{u}_0(\vec{x},t) \text{ on }\Gamma_u,
\end{gather}
where $\vec{u}$ is the displacement vector, $\rho$ is the mass
density, $\vec{f}$ is the body force vector, $\tensor{\sigma}$ is the
Cauchy stress tensor, $\vec{x}$ is the spatial coordinate, and $t$ is
time. We specify tractions $\vec{\tau}$ on boundary $\Gamma_\tau$, and
displacements $\vec{u}_0$ on boundary $\Gamma_u$. Because both $\vec{\tau}$
and $\vec{u}$ are vector quantities, there can be some spatial overlap
of boundaries $\Gamma_\tau$ and $\Gamma_u$; however, a degree of freedom at
any location cannot be associated with both prescribed displacements
(Dirichlet) and traction (Neumann) boundary conditions simultaneously.

For each fault, which is an internal interface, we add a boundary
condition to the elasticity equation prescribing the jump in the
displacement field across the fault,
\begin{gather}
  \label{eqn:bc:prescribed_slip}
  \vec{u}^+(\vec{x},t) - \vec{u}^-(\vec{x},t) - \vec{d}(\vec{x},t) = \vec{0} \text{ on }\Gamma_f,
\end{gather}
where $\vec{u}^+$ is the displacement vector on the ``positive'' side
of the fault, $\vec{u}^-$ is the displacement vector on the
``negative'' side of the fault, $\vec{d}$ is the slip vector on the
fault, and $\vec{n}$ is the fault normal which points from the
negative side of the fault to the positive side of the fault. Note
that as an alternative to prescribing the jump in displacement across
the fault, we can prescribe the jump in velocity across the fault in
terms of slip rate. 

Using a domain decomposition approach for constraining the fault slip,
yields additional Neumann-like boundary conditions on the fault
surface,
\begin{gather}
  \tensor{\sigma} \cdot \vec{n} = -\vec{\lambda}(\vec{x},t) \text{ on }\Gamma_{f^+}, \\
  \tensor{\sigma} \cdot \vec{n} = +\vec{\lambda}(\vec{x},t) \text{ on }\Gamma_{f^-},
\end{gather}
where $\vec{\lambda}$ is the vector of Lagrange multipliers
corresponding to the tractions applied to the fault surface to
generate the prescribed slip. 


\begin{table}[htbp]
  \caption{Mathematical notation for elasticity equation with
    infinitesimal strain and prescribed slip on faults.}
  \label{tab:notation:elasticity:prescribed:slip}
  \begin{tabular}{lcp{3in}}
    \toprule
    {\bf Category} & {\bf Symbol} & {\bf Description} \\
    \midrule
    Unknowns & $\vec{u}$ & Displacement field \\
    & $\vec{v}$ & Velocity field \\
    & $\vec{\lambda}$ & Lagrange multiplier field \\
    Derived quantities & $\tensor{\sigma}$ & Cauchy stress tensor \\
                   & $\tensor{\epsilon}$ & Cauchy strain tensor \\
    Common constitutive parameters & $\rho$ & Density \\
  & $\mu$ & Shear modulus \\
  & $K$ & Bulk modulus \\
Source terms & $\vec{f}$ & Body force per unit volume, for example $\rho \vec{g}$ \\
    & $\vec{d}$ & Slip vector field on the fault corresponding to a
      jump in the displacement field across the fault \\
    \bottomrule
  \end{tabular}
\end{table}


We form a first order equation using displacement $\vec{u}$ and
velocity $\vec{v}$ as unknowns. We prescribe the fault rupture in
terms of a jump in velocity for symmetry with the Lagrange
multipliers. The complete set of equations is now:
\begin{align}
  % Displacement-velocity
  \frac{\partial \vec{u}}{\partial t} &= \vec{v} \text{ in } \Omega, \\
  % Elasticity
  \rho(\vec{x}) \frac{\partial\vec{v}}{\partial t} &= \vec{f}(\vec{x},t) + \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) \text{ in } \Omega, \\
  % Neumann
  \tensor{\sigma} \cdot \vec{n} &= \vec{\tau}(\vec{x},t) \text{ on } \Gamma_\tau, \\
  % Dirichlet
  \vec{u} &= \vec{u}_0(\vec{x},t) \text{ on } \Gamma_u, \\
  % Fault
  \vec{v}^+(\vec{x},t) - \vec{v}^-(\vec{x},t) &= \vec{\dot{d}}(\vec{x},t) \text{ on } \Gamma_f, \\
  \tensor{\sigma} \cdot \vec{n} &= -\vec{\lambda}(\vec{x},t) \text{ on }\Gamma_{f^+}, \text{ and} \\
  \tensor{\sigma} \cdot \vec{n} &= +\vec{\lambda}(\vec{x},t) \text{ on }\Gamma_{f^-}.
\end{align}

We create the weak form by taking the dot product with the trial
function $\trialvec[u]$, $\trialvec[u]$, or $\trialvec[\lambda]$ and
integrating over the domain:
\begin{gather}
  % Displacement-velocity
  \int_\Omega \trialvec[u] \cdot \frac{\partial \vec{u}}{\partial t} \, d\Omega = 
  \int_\Omega \trialvec[u] \cdot \vec{v} \, d\Omega, \\
  % Elasticity
    \int_\Omega \trialvec[v] \cdot \rho(\vec{x}) \frac{\partial \vec{v}}{\partial t} \, d\Omega 
 = \int_\Omega \trialvec[u] \cdot \left( \vec{f}(t) + \tensor{\nabla} \cdot \tensor{\sigma} (\vec{u}) \right) \, d\Omega, \\
  % Prescribed slip
  \int_{\Gamma_{f}} \trialvec[\lambda] \cdot \left(
    \vec{v}^+(\vec{x},t) - \vec{v}^-(\vec{x},t) - \vec{\dot{d}}(\vec{x},t) \right) \, d\Gamma = 0.
\end{gather}
Using the divergence theorem and incorporating the Neumann boundary and fault interface
conditions, we can rewrite the second equation as
\begin{multline}
% 
  \int_\Omega \trialvec[v] \cdot \rho(\vec{x}) \frac{\partial \vec{v}}{\partial t} \, d\Omega
  = \int_\Omega \trialvec[v] \cdot \vec{f}(\vec{x},t) + \nabla \trialvec[v] : -\tensor{\sigma}(\vec{u}) \, d\Omega
  + \int_{\Gamma_\tau} \trialvec[v] \cdot \vec{\tau}(\vec{x},t) \, d\Gamma\\
  + \int_{\Gamma_{f}} \trialvec[v^+] \cdot \left(-\vec{\lambda}(\vec{x},t)\right)
  + \trialvec[v^-] \cdot \left(+\vec{\lambda}(\vec{x},t)\right)\, d\Gamma
\end{multline}
Rearranging the terms so that the Lagrange multiplier related terms appear on the LHS (implicit part), we have
\begin{gather}
  % Displacement-velocity
  \int_\Omega \trialvec[u] \cdot \frac{\partial \vec{u}}{\partial t} \, d\Omega = 
  \int_\Omega \trialvec[u] \cdot \vec{v} \, d\Omega, \\
  % Elasticity
  \begin{multlined}
  \int_\Omega \trialvec[v] \cdot \rho(\vec{x}) \frac{\partial \vec{v}}{\partial t} \, d\Omega
  + \int_{\Gamma_{f}} \trialvec[v^+] \cdot \left(+\vec{\lambda}(\vec{x},t)\right)
  + \trialvec[v^-] \cdot \left(-\vec{\lambda}(\vec{x},t)\right)\, d\Gamma \\
  = \int_\Omega \trialvec[v] \cdot \vec{f}(\vec{x},t) + \nabla \trialvec[v] : -\tensor{\sigma}(\vec{u}) \, d\Omega
  + \int_{\Gamma_\tau} \trialvec[v] \cdot \vec{\tau}(\vec{x},t) \, d\Gamma,
  \end{multlined}\\
  % Prescribed slip
  \int_{\Gamma_{f}} \trialvec[\lambda] \cdot \left(
    \vec{v}^+(\vec{x},t) - \vec{v}^-(\vec{x},t) - \vec{\dot{d}}(\vec{x},t) \right) \, d\Gamma = 0.
\end{gather}

\subsection{Residual Pointwise Kernels}

Identifying $F(t,s,\dot{s})$ and $G(t,s)$, we have
\begin{align}
  % Fu
  F^u(t,s,\dot{s}) &=  \int_\Omega \trialvec[u] \cdot \eqnannotate{\frac{\partial \vec{u}}{\partial t}}{\vec{f}^u_0} \, d\Omega, \\
  % Fv
  F^v(t,s,\dot{s}) &=  \int_\Omega \trialvec[v] \cdot \eqnannotate{\rho(\vec{x}) \frac{\partial \vec{v}}{\partial t}}{\vec{f}^v_0} \, d\Omega
            + \int_{\Gamma_{f}} \trialvec[v^+] \cdot \eqnannotate{\left(+\vec{\lambda}(\vec{x},t)\right)}{\vec{f}^v_0}
                     + \trialvec[v^-] \cdot \eqnannotate{\left(-\vec{\lambda}(\vec{x},t)\right)}{\vec{f}^v_0}\, d\Gamma \\
  % Fl
  F^\lambda(t,s,\dot{s}) &= \int_{\Gamma_{f}} \trialvec[\lambda] \cdot \eqnannotate{\left(
    \vec{v}^+(\vec{x},t) - \vec{v}^-(\vec{x},t) - \vec{\dot{d}}(\vec{x},t) \right)}{\vec{f}^\lambda_0} \, d\Gamma, \\
  % Gu
  G^u(t,s) &= \int_\Omega \trialvec[u] \cdot \eqnannotate{\vec{v}}{\vec{g}^u_0} \, d\Omega, \\
  % Gv
  G^v(t,s) &=  \int_\Omega \trialvec[v] \cdot \eqnannotate{\vec{f}(\vec{x},t)}{\vec{g}^v_0} + \nabla \trialvec[v] : \eqnannotate{-\tensor{\sigma}(\vec{u})}{\tensor{g^v_1}} \, d\Omega
  + \int_{\Gamma_\tau} \trialvec[v] \cdot \eqnannotate{\vec{\tau}(\vec{x},t)}{\vec{g}^v_0} \, d\Gamma, \\
  % Gl
  G^\lambda(t,s) &= 0
\end{align}
Note that we have multiple $\vec{f}_0$ and $\vec{g}_0^u$ functions, each
associated with a trial function and an integral over a different
domain or boundary. Each material, internal interface, and boundary
condition (except Dirichlet) contribute pointwise functions. The
integrals over the domain $\Omega$ are associated with materials, the
integral over the boundary $\Gamma_\tau$ is associated with Neumann
boundary conditions, and the integrals over the interface $\Gamma_{f}$
are associated with faults (cohesive cells).

\subsection{Jacobian Pointwise Kernels}

The LHS Jacobians are:
\begin{align}
  % J_F uu
  J_F^{uu} &= \frac{\partial F^u}{\partial u} + s_\mathit{tshift} \frac{\partial F^u}{\partial \dot{u}} =
             \int_\Omega \trialscalar[u]_i \eqnannotate{s_\mathit{tshift} \delta_{ij}}{J^{uu}_{f0}} \basisscalar[u]_j  \, d\Omega, \\
  % J_F vv
  J_F^{vv} &= \frac{\partial F^v}{\partial v} + s_\mathit{tshift} \frac{\partial F^v}{\partial \dot{v}} =
             \int_\Omega \trialscalar[v]_i \eqnannotate{\rho(\vec{x}) s_\mathit{tshift} \delta_{ij}}{J ^{vv}_{f0}} \basisscalar[v]_j \, d\Omega \\
  % J_F vl
  J_F^{v\lambda} &= \frac{\partial F^v}{\partial \lambda} + s_\mathit{tshift} \frac{\partial F^v}{\partial \dot{\lambda}} =
                    \int_{\Gamma_{f}} \trialscalar[v^+]_i \eqnannotate{\left(+\delta_{ij}\right)}{J^{v\lambda}_{f0}} \basisscalar[\lambda]_j
                   + \trialscalar[v^-]_i \eqnannotate{\left(-\delta_{ij}\right)}{J^{v\lambda}_{f0}} \basisscalar[\lambda]_j\, d\Gamma \\
  % J_F lv
  J_F^{\lambda v} &= \frac{\partial F^\lambda}{\partial v} + s_\mathit{tshift} \frac{\partial F^\lambda}{\partial \dot{v}} =
                    \int_{\Gamma_{f}} \trialscalar[\lambda]_i 
                    \eqnannotate{\left(+\delta_{ij}\right)}{J^{\lambda v}_{f0}} \basisscalar[v^+]_j
                    + \trialscalar[\lambda]_i \eqnannotate{\left(-\delta_{ij}\right)}{J^{\lambda v}_{f0}} \basisscalar[v^-]_j \, d\Gamma.
\end{align}
The RHS Jacobians are:
\begin{align}
  % J_G uv
  J_G^{uv} &= \frac{\partial G^u}{\partial v} =
            \int_\Omega \trialscalar[u]_i \eqnannotate{\delta_{ij}}{J^{uv}_{g0}} \basisscalar[v]_j \, d\Omega , \\
% J_G vu
  J_G^{vu} &= \frac{\partial G^v}{\partial u} = \int_\Omega \nabla \trialvec[v] : 
\frac{\partial}{\partial u}(-\tensor{\sigma}) \, d\Omega 
  = \int_\Omega \nabla \trialvec[v] : -\tensor{C} : \frac{1}{2}(\nabla + \nabla^T)\basisvec[u] 
\, d\Omega 
  = \int_\Omega \trialscalar[v]_{i,k} \, \eqnannotate{\left( -C_{ikjl} \right)}{J_{g3}^{vu}} \, \basisscalar[u]_{j,l}\, d\Omega
\end{align}


\subsection{Quasistatic}

If we neglect the inertial term
($\rho \frac{\partial v}{\partial t}$), then time dependence only
arises from history-dependent constitutive equations and boundary
conditions. We can drop velocity from the solution field and use the
displacement $\vec{u}$ and Lagrange multiplier $\vec{\lambda}$ fields
as the unknowns. In doing so, we prescribe fault rupture using a jump
in the displacement field in terms of fault slip. Our set of equations reduces to

\begin{align}
  % Solution
  \vec{s}^T &= \left( \begin{array}{cc} \vec{u} & \vec{\lambda} \end{array} \right)^T \\
  % Elasticity
  \vec{0} &= \vec{f}(\vec{x},t) + \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) \text{ in } \Omega, \\
  % Neumann
  \tensor{\sigma} \cdot \vec{n} &= \vec{\tau}(\vec{x},t) \text{ on } \Gamma_\tau, \\
  % Dirichlet
  \vec{u} &= \vec{u}_0(\vec{x},t) \text{ on } \Gamma_u, \\
  % Fault
  \vec{u}^+(\vec{x},t) - \vec{u}^-(\vec{x},t) &= \vec{d}(\vec{x},t) \text{ on } \Gamma_f, \\
  \tensor{\sigma} \cdot \vec{n} &= -\vec{\lambda}(\vec{x},t) \text{ on }\Gamma_{f^+}, \text{ and} \\
  \tensor{\sigma} \cdot \vec{n} &= +\vec{\lambda}(\vec{x},t) \text{ on }\Gamma_{f^-}.
\end{align}

We solve the system of equations using implicit time stepping, making
use of residuals functions and Jacobians for both the LHS and RHS.

\subsubsection{Residual Pointwise Kernels}

The residual functions simplify to
\begin{align}
  % Fu
  F^u(t,s,\dot{s}) &= \int_{\Gamma_{f}} \trialvec[u^+] \cdot \eqnannotate{\left(+\vec{\lambda}(\vec{x},t)\right)}{\vec{f}^u_0}
                     + \trialvec[u^-] \cdot \eqnannotate{\left(-\vec{\lambda}(\vec{x},t)\right)}{\vec{f}^u_0}\, d\Gamma \\
  % Fl
  F^\lambda(t,s,\dot{s}) &= \int_{\Gamma_{f}} \trialvec[\lambda] \cdot \eqnannotate{\left(
    \vec{u}^+(\vec{x},t) - \vec{u}^-(\vec{x},t) - \vec{d}(\vec{x},t) \right)}{\vec{f}^\lambda_0} \, d\Gamma, \\
  % Gu
  G^u(t,s) &=  \int_\Omega \trialvec[u] \cdot \eqnannotate{\vec{f}(\vec{x},t)}{\vec{g}^u_0} + \nabla \trialvec[u] : \eqnannotate{-\tensor{\sigma}(\vec{u})}{\tensor{g^u_1}} \, d\Omega
  + \int_{\Gamma_\tau} \trialvec[u] \cdot \eqnannotate{\vec{\tau}(\vec{x},t)}{\vec{g}^u_0} \, d\Gamma, \\
  % Gl
  G^\lambda(t,s) &= 0
\end{align}

\subsubsection{Jacobian Pointwise Kernels}

The LHS Jacobians are:
\begin{align}
  % J_F uu
  J_F^{uu} &= \tensor{0} \\
  J_F^{u\lambda} &= \frac{\partial F^u}{\partial \lambda} + s_\mathit{tshift} \frac{\partial F^u}{\partial \dot{\lambda}} =
                    \int_{\Gamma_{f}} \trialscalar[u^+]_i \eqnannotate{\left(+\delta_{ij}\right)}{J^{u\lambda}_{f0}} \basisscalar[\lambda]_j
                     + \trialscalar[u^-]_i \eqnannotate{\left(-\delta_{ij}\right)}{J^{u\lambda}_{f0}} \basisscalar[\lambda]_j\, d\Gamma, \\
  J_F^{\lambda u} &= \frac{\partial F^\lambda}{\partial u} + s_\mathit{tshift} \frac{\partial F^\lambda}{\partial \dot{u}} =
                    \int_{\Gamma_{f}} \trialscalar[\lambda]_i 
                    \eqnannotate{\left(+\delta_{ij}\right)}{J^{\lambda u}_{f0}} \basisscalar[u^+]_j
                    + \trialscalar[\lambda]_i \eqnannotate{\left(-\delta_{ij}\right)}{J^{\lambda u}_{f0}} \basisscalar[u^-]_j \, d\Gamma, \\
  J_F^{\lambda \lambda} &= \tensor{0}
\end{align}
This resulting LHS Jacobian has the structure
\begin{equation}
  J_F = \left( \begin{array} {cc} 0 & J_F^{u\lambda} \\ J_F^{\lambda u} & 0 \end{array} \right).
\end{equation}

The RHS Jacobians are:
\begin{align}
% J_G uu
  J_G^{uu} &= \frac{\partial G^u}{\partial u} = \int_\Omega \nabla \trialvec[u] : 
\frac{\partial}{\partial u}(-\tensor{\sigma}) \, d\Omega 
  = \int_\Omega \nabla \trialvec[u] : -\tensor{C} : \frac{1}{2}(\nabla + \nabla^T)\basisvec[u] 
\, d\Omega 
  = \int_\Omega \trialscalar[u]_{i,k} \, \eqnannotate{\left( -C_{ikjl} \right)}{J_{g3}^{uu}} \, \basisscalar[u]_{j,l}\, d\Omega
\end{align}
The resulting RHS Jacobian has the structure
\begin{equation}
  J_G = \left( \begin{array} {cc} J_G^{uu} & 0 \\ 0 & 0 \end{array} \right).
\end{equation}
The complete Jacobian has the form
\begin{equation}
  J = \left(
    \begin{array}{cc}
      J_G^{uu} & -J_f^{u \lambda} \\
      -J_f^{\lambda u} & 0
    \end{array} \right) = 
  \left(
    \begin{array}{cc}
      J_G^{uu} & -C^T \\
      -C & 0
    \end{array} \right),
\end{equation}
where $C$ contains entries of $\pm 1$ for degrees of
freedom on the two sides of the fault. The Schur complement of $J$
with respect to $J_G^{uu}$ is $-C\left(J_G^{uu}\right)^{-1}C^T$.

\subsection{Dynamic Without Fault}

If we do not have a fault, then the system of equations reduces to
\begin{align}
  % Displacement-velocity
  \frac{\partial \vec{u}}{\partial t} &= \vec{v} \text{ in } \Omega, \\
  % Elasticity
  \rho(\vec{x}) \frac{\partial\vec{v}}{\partial t} &= \vec{f}(\vec{x},t) + \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) \text{ in } \Omega, \\
  % Neumann
  \tensor{\sigma} \cdot \vec{n} &= \vec{\tau}(\vec{x},t) \text{ on } \Gamma_\tau, \\
  % Dirichlet
  \vec{u} &= \vec{u}_0(\vec{x},t) \text{ on } \Gamma_u.
\end{align}

We can solve these equations using explicit time stepping. We solve an
augmented system in which we multiply the RHS residual function by the
inversion of the lumped LHS Jacobian,
\begin{gather}
  F^*(t,s,\dot{s}) = G^*(t,s) \text{, where} \\
  F^*(t,s,\dot{s}) = \dot{s} \text{ and} \\
  G^*(t,s) = J_F^{-1} G(t,s).
\end{gather}


\subsubsection{Residual Pointwise Kernels}

The PETSc TS assumes the LHS is $\dot{s}$, so we only need the RHS residual functions:
\begin{align}
  % Gu
  G^u(t,s) &= \int_\Omega \trialvec[u] \cdot \eqnannotate{\vec{v}}{\vec{g}^u_0} \, d\Omega, \\
  % Gv
  G^v(t,s) &=  \int_\Omega \trialvec[v] \cdot \eqnannotate{\vec{f}(\vec{x},t)}{\vec{g}^v_0} + \nabla \trialvec[v] : \eqnannotate{-\tensor{\sigma}(\vec{u})}{\tensor{g^v_1}} \, d\Omega
  + \int_{\Gamma_\tau} \trialvec[v] \cdot \eqnannotate{\vec{\tau}(\vec{x},t)}{\vec{g}^v_0} \, d\Gamma,
\end{align}

\subsubsection{Jacobian Pointwise Kernels}

We premultiply the RHS residual function by the inverse of the lumped
LHS Jacobian while $s_\mathit{tshift}$ remains on the LHS with
$\dot{s}$. As a result, we use the usual LHS Jacobian pointwise
kernel, but set $s_\mathit{tshift}=1$.  The LHS Jacobians are:
\begin{align}
  % J_F uu
  J_F^{uu} &= \frac{\partial F^u}{\partial u} + s_\mathit{tshift} \frac{\partial F^u}{\partial \dot{u}} =
             \int_\Omega \trialscalar[u]_i \eqnannotate{s_\mathit{tshift} \delta_{ij}}{J^{uu}_{f0}} \basisscalar[u]_j  \, d\Omega, \\
  % J_F vv
  J_F^{vv} &= \frac{\partial F^v}{\partial v} + s_\mathit{tshift} \frac{\partial F^v}{\partial \dot{v}} =
             \int_\Omega \trialscalar[v]_i \eqnannotate{\rho(\vec{x}) s_\mathit{tshift} \delta_{ij}}{J ^{vv}_{f0}} \basisscalar[v]_j \, d\Omega
\end{align}


\subsection{Dynamic}

We use a segragated Runge-Kutta approach \cite{Colomes:Badia:2016} to
solve the dynamic elasticity equation with prescribed fault slip. This
approach can be applied in an implicit-explicit Runge-Kutta scheme or
a pure explicit Runge-Kutta scheme. We prefer the pure explicit
Runge-Kutta scheme, which involves reducing the system of equations by
solving for the Lagrange multiplier analytically.

In the segragated Runge-Kutta approach, we solve a system of equations of the form:
\begin{gather}
  \dot{s} = G(t,s) \\
  F(s,\dot{s}) = 0.
\end{gather}
We differentiate the second equation with respect to time and use the
first equation to substitute for $\dot{s}$, so that the second
equation has the form $F(G(t,s)) = 0$.

Starting with the strong form, we have 
\begin{gather}
  % Displacement-velocity
  \frac{\partial u}{\partial t} = v \\
  % Elasticity
  \rho \frac{\partial \vec{v}}{\partial t} - \vec{f}(\vec{x},t)
  - \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \text{ in }\Omega, \\
% Neumann
  \tensor{\sigma} \cdot \vec{n} = \vec{\tau}(\vec{x},t) \text{ on }\Gamma_\tau, \\
% Dirichlet
  \vec{u} = \vec{u}_0(\vec{x},t) \text{ on }\Gamma_u,\\
% Prescribed slip
  \vec{\dot{v}}^+(\vec{x},t) - \vec{\dot{v}}^-(\vec{x},t) - \vec{\ddot{d}}(\vec{x},t) = \vec{0} \text{ on }\Gamma_f,
\end{gather}
where we have taken the second time derivative of the fault slip
constraint to match the order of the time derivative in the elasticity
equation. Our corresponding weak form is
\begin{gather}
  % Displacement-velocity
  \int_{\Omega} \trialvec[u] \cdot \frac{\partial \vec{u}}{\partial t} \, d\Omega = 
  \int_{\Omega} \trialvec[u] \cdot \vec{v} \, d\Omega, \\
  % Elasticity
  \label{eqn:dynamic:prescribed:slip:elasticity}
  \begin{multlined}
  \int_{\Omega} \trialvec[v] \cdot \frac{\partial \vec{v}}{\partial t} \, d\Omega 
  = M^{-1} \left( \int_\Omega \trialvec[v] \cdot \vec{f}(\vec{x},t) + \nabla \trialvec[v] : -\tensor{\sigma}(\vec{u}) \, d\Omega
  + \int_{\Gamma_\tau} \trialvec[v] \cdot \vec{\tau}(\vec{x},t) \, d\Gamma \right) \\
  + M^{-1} \left( \int_{\Gamma_{f}} \trialvec[v^+] \cdot \left(-\vec{\lambda}(\vec{x},t)\right)
  + \trialvec[v^-] \cdot \left(+\vec{\lambda}(\vec{x},t)\right)\, d\Gamma \right)
  \end{multlined}\\
  % Prescribed slip
  \label{eqn:dynamic:prescribed:slip:second:derivative}
  \int_{\Gamma_{f}} \trialvec[\lambda] \cdot \left(
    \vec{\dot{v}}^+(\vec{x},t) - \vec{\dot{v}}^-(\vec{x},t) - \vec{\ddot{d}}(\vec{x},t) \right) \, d\Gamma = 0, \\
  % Mass matrix
  M = \int_{\Omega} \trialscalar[v]_i \rho(\vec{x}) \delta_{ij} \basisscalar[v]_j \, d\Omega.
\end{gather}
We substitute the expression for $\dot{v}$ from
equation~\ref{eqn:dynamic:prescribed:slip:elasticity} into
equation~\ref{eqn:dynamic:prescribed:slip:second:derivative},
\begin{gather}
M^{-1} \left( h^+ - h^- \right) + M^{-1} \int_{\Gamma_{f}} \trialvec[v^+] \cdot \left(-\vec{\lambda}(\vec{x},t)\right)
  + \trialvec[v^-] \cdot \left(-\vec{\lambda}(\vec{x},t)\right)\, d\Gamma - \int_{\Gamma_f} \trialvec[\lambda] \cdot \vec{\ddot{d}}(\vec{x},t) \, d\Gamma = 0, \\
  h^+ = \int_{\Omega} \trialvec[v^+] \cdot \vec{f}(\vec{x},t) + \nabla \trialvec[v^+] : -\tensor{\sigma}(\vec{u}) \, d\Omega, \\
  h^- = \int_{\Omega} \trialvec[v^-] \cdot \vec{f}(\vec{x},t) + \nabla \trialvec[v^-] : -\tensor{\sigma}(\vec{u}) \, d\Omega.
\end{gather}
Assuming $\trialvec[v] = \trialvec[\lambda]$, we can rewrite the Lagrange multiplier integration:
\begin{equation}
  \int_{\Gamma_{f}} \trialvec[v^+] \cdot \left(-\vec{\lambda}(\vec{x},t)\right)
    + \trialvec[v^-] \cdot \left(-\vec{\lambda}(\vec{x},t)\right)\, d\Gamma =
    -2 \int_{\Gamma_f} \trialvec[\lambda] \cdot \vec{\lambda}(\vec{x},t) \, d\Gamma.
\end{equation}
Solving for the Lagrange multiplier term yields
\begin{equation}
  M^{-1} \int_{\Gamma_f} \trialvec[\lambda] \cdot \vec{\lambda}(\vec{x},t) \, d\Gamma =
  \frac{1}{2} M^{-1} \left( h^+ - h^- \right)
  -\frac{1}{2} \int_{\Gamma_f} \trialvec[\lambda] \cdot \vec{\ddot{d}}(\vec{x},t) \, d\Gamma.
\end{equation}
We can now write the expressions for the Lagrange multiplier terms in
equation~\ref{eqn:dynamic:prescribed:slip:elasticity},
\begin{gather}
  % v+
  M^{-1} \int_{\Gamma_f} \trialvec[v^+] \cdot \left(-\vec{\lambda}(\vec{x},t)\right) \, d\Gamma =
-\frac{1}{2} M^{-1} \left( h^+ - h^- \right) +\frac{1}{2} \int_{\Gamma_f} \trialvec[v^+] \cdot \vec{\ddot{d}}(\vec{x},t) \, d\Gamma, \\ 
% v-
  M^{-1} \int_{\Gamma_f} \trialvec[v^-] \cdot \left(+\vec{\lambda}(\vec{x},t)\right) \, d\Gamma =
+\frac{1}{2} M^{-1} \left( h^+ - h^- \right) -\frac{1}{2} \int_{\Gamma_f} \trialvec[v^+] \cdot \vec{\ddot{d}}(\vec{x},t) \, d\Gamma, \\ 
\end{gather}
The updated weak form with the Lagrange multipliers eliminated is:
\begin{gather}
  % Displacement-velocity
  \int_{\Omega} \trialvec[u] \cdot \frac{\partial \vec{u}}{\partial t} \, d\Omega = 
  \int_{\Omega} \trialvec[u] \cdot \vec{v} \, d\Omega, \\
  % Elasticity
 \int_{\Omega} \trialvec[v] \cdot \frac{\partial \vec{v}}{\partial t} \, d\Omega 
  = \begin{cases}
    M^{-1} h & v \neq v^+ \text{ or } v^- \\
    M^{-1} h^+ - \frac{1}{2} M^{-1} \left( h^+-h^- \right) + \frac{1}{2} \int_{\Gamma_f} \trialvec[v^+] \cdot \vec{\ddot{d}}(\vec{x}, t) & v = v^+ \\
    M^{-1} h^- + \frac{1}{2} M^{-1} \left( h^+-h^- \right) - \frac{1}{2} \int_{\Gamma_f} \trialvec[v^+] \cdot \vec{\ddot{d}}(\vec{x}, t) & v = v^+
  \end{cases}, \\
  M = \int_{\Omega} \trialscalar[v]_i \rho(\vec{x}) \delta_{ij} \basisscalar[v]_j \, d\Omega, \\
  h = \int_{\Omega} \trialvec[v] \cdot \vec{f}(\vec{x},t) + \nabla \trialvec[v] : -\tensor{\sigma}(\vec{u}) \, d\Omega.
\end{gather}

\subsection{Residual Pointwise Kernels}

Identifying $G(t,s)$, we have
%\begin{align}
  % Gu
  % Gv
%\end{align}



% End of file